define(function(require){function e(){for(var e=i.$suggestTarget.children(),t=e.length,n=0;t>n;n++)$(e[n]).hasClass("selected")&&$(e[n]).removeClass("selected")}var $=require("jquery"),t=require("util"),n=require("common/config"),o=require("common/login"),i={};i.$suggestText=$("#suggestion-text"),i.$suggestTarget=$("#suggestion-target"),i.$login=$("#login-btn"),i.$changeCity=$("#change-city"),i.$cityLayer=$("#zb-city-layer"),i.$suggestText.on("focus",function(){var e=$(this);"商家名称联想"===t.str.trim(e.val())&&(e.val(""),$(this).css({color:"#000"}))}),i.$suggestText.on("blur",function(){var e=$(this);""===t.str.trim(e.val())&&(e.val("商家名称联想"),$(this).css({color:"#999"}))}),i.$suggestText.on("keyup",function(e){var o=$(this);o.val()!==o.data("val")&&(o.data("val",o.val()),t.str.trim(o.val())?$.ajax({url:n.AJAX.SEARCH_SUGGESTION+o.val(),dataType:"jsonp",jsonp:"callback",success:function(e){if(e&&e.shop){for(var t="",n=e.shop.length,o=0;n>o;o++)t+='<a target="_blank" href="http://zanbai.com/shop?shop_id='+e.shop[o].word_id+'">'+e.shop[o].word+"</a>";i.$suggestTarget.css({display:""}),i.$suggestTarget.html(t)}else i.$suggestTarget.css({display:"none"}),i.$suggestTarget.html("")}}):(i.$suggestTarget.css({display:"none"}),i.$suggestTarget.html(""))),e.stopPropagation(),e.preventDefault()}),$(document).click(function(e){var n=e.srcElement||e.target;n.parentNode&&"suggestion-target"!==n.parentNode.id&&"suggestion-text"!==n.id&&i.$suggestTarget.css({display:"none"});var o=i.$cityLayer[0];o&&(t.dom.contains(o,n)||"change-city"==n.getAttribute("id")||(o.style.display="none"))}),$(document).keydown(function(t){var n=t.keyCode?t.keyCode:t.which,o=i.$suggestTarget.css("display");if("none"!==o){for(var a,s=i.$suggestTarget.children(),r=s.length,c=0;r>c;c++)if($(s[c]).hasClass("selected")){a={elem:s[c],index:c};break}40==n?(a?a.index+1===r?(e(),$(s[0]).addClass("selected")):(e(),$(s[a.index+1]).addClass("selected")):(a={elem:s[0],index:0},$(s[a.index]).addClass("selected")),t.stopPropagation(),t.preventDefault()):38==n?(a?0===a.index?(e(),$(s[r-1]).addClass("selected")):(e(),$(s[a.index-1]).addClass("selected")):(a={elem:s[r-1],index:r-1},$(s[a.index]).addClass("selected")),t.stopPropagation(),t.preventDefault()):13==n&&(setTimeout(function(){a.elem&&a.elem.click()},10),t.stopPropagation(),t.preventDefault())}}),i.$suggestTarget.mouseover(function(e){var t=e.target||e.srcElement,n=t.tagName.toLowerCase();"a"==n&&$(t).addClass("selected")}).mouseout(function(t){var n=t.target||t.srcElement,o=n.tagName.toLowerCase();"a"==o&&e()}),i.$login.click(function(){o.show()}),i.$changeCity.on("click",function(){var e=i.$cityLayer[0];if(e){var t=i.$cityLayer.css("display");t="none"==t?"":"none",i.$cityLayer.css("display",t)}}),$(document.body).delegate("[action-type=follow]","click",function(e){if(0==window.$CONFIG.isLogin)o.show();else{var i=e.currentTarget,a=$(i),s=t.json.queryToJson(a.attr("action-data"));$.ajax({type:"post",url:n.AJAX.FOLLOW,dataType:"json",data:{to_uid:s.uid},success:function(e){200==e.code?(a.removeClass("W_btn_b"),a.addClass("W_btn_a"),a.html("<span>已关注</span>"),a.attr("action-type","unfollow")):popup.alertPopup(e.msg)}})}e.stopPropagation(),e.preventDefault()}),$(document.body).delegate("[action-type=unfollow]","click",function(e){var o=e.currentTarget,i=$(o),a=t.json.queryToJson(i.attr("action-data"));$.ajax({type:"post",url:n.AJAX.UNFOLLOW,dataType:"json",data:{to_uid:a.uid},success:function(){i.removeClass("W_btn_a"),i.addClass("W_btn_b"),i.html("<span>关注</span>"),i.attr("action-type","follow")}}),e.stopPropagation(),e.preventDefault()}),$(document.body).delegate("[action-type=unfollow]","mouseenter",function(e){var t=e.currentTarget,n=$(t);n.html("<span>取消关注</span>"),e.stopPropagation(),e.preventDefault()}),$(document.body).delegate("[action-type=unfollow]","mouseleave",function(e){var t=e.currentTarget,n=$(t);n.html("<span>已关注</span>"),e.stopPropagation(),e.preventDefault()})});