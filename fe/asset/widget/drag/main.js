define(function(require){function t(t,e){var i=function(t){return t.cancelBubble=!0,!1},a=function(t,e){return t.clientX=e.clientX,t.clientY=e.clientY,t.pageX=e.clientX+$(document).scrollLeft(),t.pageY=e.clientY+$(document).scrollTop(),t};if(!n.dom.isNode(t))throw"dragBase need Element as first parameter";var r=$.extend({actRect:[],actObj:{}},e),s={},c=n.evt.custEvent.define(r.actObj,"dragStart"),l=(n.evt.custEvent.define(r.actObj,"dragEnd"),n.evt.custEvent.define(r.actObj,"draging"),function(t){var e=a({},t);return document.body.onselectstart=function(){return!1},$(document).on("mousemove",d),$(document).on("mouseup",u),$(document).on("click",i,!0),o.msie||(t.preventDefault(),t.stopPropagation()),n.evt.custEvent.fire(c,"dragStart",e),!1}),d=function(t){var e=a({},t);t.cancelBubble=!0,n.evt.custEvent.fire(c,"draging",e)},u=function(t){var e=a({},t);document.body.onselectstart=function(){return!0},$(document).off("mousemove",d),$(document).off("mouseup",u),$(document).off("click",i,!0),n.evt.custEvent.fire(c,"dragEnd",e)};return $(t).on("mousedown",l),s.destroy=function(){$(t).off("mousedown",l),r=null},s.getActObj=function(){return r.actObj},s}function e(e,o){var i,a,r,s,c,l,d,u,p=function(){f(),m()},f=function(){i=$.extend({moveDom:e,perchStyle:"border:solid #999999 2px;",dragtype:"perch",actObj:{},pagePadding:5,dragStart:function(){},dragEnd:function(){},draging:function(){}},o),r=i.moveDom,a={},s={},c=t(e,{actObj:i.actObj}),"perch"===i.dragtype&&(l=document.createElement("div"),d=!1,u=!1,r=l),e.style.cursor="move"},m=function(){n.evt.custEvent.add(i.actObj,"dragStart",h),n.evt.custEvent.add(i.actObj,"dragEnd",v),n.evt.custEvent.add(i.actObj,"draging",y)},h=function(t,n){if(document.body.style.cursor="move",s=$(i.moveDom).position(),s.pageX=n.pageX,s.pageY=n.pageY,s.height=i.moveDom.offsetHeight,s.width=i.moveDom.offsetWidth,s.pageHeight=$(document).height(),s.pageWidth=$(document).width(),"perch"===i.dragtype){var o=[];o.push(i.perchStyle),o.push("position:absolute"),o.push("z-index:"+(parseInt(i.moveDom.style.zIndex,10)+10)),o.push("width:"+i.moveDom.offsetWidth+"px"),o.push("height:"+i.moveDom.offsetHeight+"px"),o.push("left:"+s.left+"px"),o.push("top:"+s.top+"px"),l.style.cssText=o.join(";"),u=!0,setTimeout(function(){u&&(document.body.appendChild(l),d=!0)},100)}void 0!==e.setCapture&&e.setCapture(),i.dragStart(r,n,e)},v=function(t,n){document.body.style.cursor="auto",void 0!==e.setCapture&&e.releaseCapture(),"perch"===i.dragtype&&(u=!1,$(i.moveDom).css({left:parseInt(l.style.left),top:parseInt(l.style.top)}),d&&(document.body.removeChild(l),d=!1)),i.dragEnd(r,n,e)},y=function(t,n){var o=s.top+(n.pageY-s.pageY),a=s.left+(n.pageX-s.pageX),c=o+s.height,l=a+s.width,d=s.pageHeight-i.pagePadding,u=s.pageWidth-i.pagePadding;d>c&&o>0?$(r).css({top:o}):(0>o&&$(r).css({top:0}),c>=d&&$(r).css({top:d-s.height})),u>l&&a>0?$(r).css({left:a}):(0>a&&$(r).css({left:0}),l>=u&&$(r).css({left:u-s.width})),i.draging(r,n,e)};return p(),a.destroy=function(){document.body.style.cursor="auto","function"==typeof r.setCapture&&r.releaseCapture(),"perch"===i.dragtype&&(u=!1,d&&(document.body.removeChild(l),d=!1)),n.evt.custEvent.remove(i.actObj,"dragStart",h),n.evt.custEvent.remove(i.actObj,"dragEnd",v),n.evt.custEvent.remove(i.actObj,"draging",y),c.destroy&&c.destroy(),i=null,r=null,s=null,c=null,l=null,d=null,u=null},a.getActObj=function(){return i.actObj},a}var $=require("jquery"),n=require("util"),o=$.browser;return{drag:e}});