define(function(require){function e(n){p.$shopIntro.animate({height:h},500,function(){}),p.$seeMore.html('<a href="javascript:void(0);" class="linkb">收起</a>'),p.$seeMore.off("click",e),p.$seeMore.on("click",t),n.preventDefault()}function t(n){p.$shopIntro.animate({height:245},{duration:500,queue:!1,complete:function(){}}),$("html,body").animate({scrollTop:p.$shopName.position().top},{duration:500,queue:!1}),p.$seeMore.html('<a href="javascript:void(0);" class="linkb">展开更多</a>'),p.$seeMore.off("click",t),p.$seeMore.on("click",e),n.preventDefault()}function n(e){$.ajax({type:"GET",url:s.AJAX.GET_SHOPPIC,dataType:"json",data:e.lastId?{shop_id:y,last_id:e.lastId}:{shop_id:y},success:function(t){if("200"==t.code)if(b=t.msg.last_id,_=_.concat(t.msg.pics),0!=b)o(e.imgIndex?e.imgIndex:0);else{var n=e.imgIndex?e.imgIndex:0;v=r.compile(x).render({imgSrc:_[n],imgIndex:n}),w.setContent(v),w.show(),w.setMiddle(),$("#popImg").css("min-height","300px")}}})}function o(e){v=r.compile(x).render({imgSrc:_[e],imgIndex:e}),w.setContent(v),0==e&&(w.show(),w.setMiddle(),$("#popImg").css("min-height","300px")),$("#nextImg").click(function(){var e=parseInt($("#popImg").attr("imgindex"),10),t=e+1;0!=b?t==_.length?n({lastId:b,imgIndex:t}):o(t):e+1!=_.length&&o(t)}),$("#prevImg").click(function(){var e=parseInt($("#popImg").attr("imgindex"),10),t=e-1;t>=0&&o(t)})}var $=require("jquery"),i=require("util"),a=require("widget/pager/main"),s=require("shop_detail/config"),r=require("hogan"),c=require("common/login"),l=require("widget/popup/main"),d=require("widget/richeditor/main"),u=require("widget/rating/main"),p={};p.$shopIntro=$("#shop_intro"),p.$seeMore=$("#see_more"),p.$shopName=$("#shop-name"),p.$showList=$("#showList"),p.$showMap=$("#show-detailmap"),p.$showImgPop=$("#showImgPop"),p.$commentList=$("#comment_list"),p.$showList.click(function(e){if(0==window.$CONFIG.isLogin)c.show();else{var t=i.json.queryToJson($(this).attr("node-data"));d.show({confirmFn:function(e,n){if(i.str.trim(e)){var o="",a=/src=[\'\"]?([^\'\"]*)[\'\"]?/i,r=e.match(/<img.*?(?:>|\/>)/gi);if(r)for(var c=0;c<r.length;c++){var d=r[c].match(a);d[1]&&(o+=d[1].replace(/!popup$/,"")+",")}$.ajax({type:"post",url:s.AJAX.ADD_DIANPING,dataType:"json",data:{body:encodeURIComponent(e),pics:o.replace(/,$/,""),shop_id:t&&t.shop_id,score:u.getResult()},success:function(e){"200"==e.code?(n.destroy(),p.$commentList.prepend(e.html),l.litePrompt("晒单成功！",{timeout:1500})):(n.destroy(),l.litePrompt(e.msg,{timeout:1500}))}})}else l.alertPopup("点评内容不能为空")}}),u.init({elemId:"rating"})}e.stopPropagation(),e.preventDefault()});var f='<div class="textarea_wrap textb clearfix"><textarea class="send_textarea"></textarea><div class="btn_wrap fr"><span>禁止发布色情、反动及广告内容！</span><a href="javascript:void(0);" action-type="send_comment" action-data="{{actionDataStr}}" class="post_btn">发送</a></div></div>';p.$commentList.delegate("[action-type=reply]","click",function(e){if(0==window.$CONFIG.isLogin)c.show();else{var t=r.compile(f).render({actionDataStr:$(this).attr("action-data")});$(this).parent().parent().after(t),$(this).attr("action-type","unreply")}e.stopPropagation(),e.preventDefault()}),p.$commentList.delegate("[action-type=unreply]","click",function(e){$(this).parent().parent().next().remove(),$(this).attr("action-type","reply"),e.stopPropagation(),e.preventDefault()}),p.$commentList.delegate("[action-type=send_comment]","click",function(e){if(0==window.$CONFIG.isLogin)c.show();else{var t=$(this).parent().parent(),n=$(this).parent().prev();if(i.str.trim(n.val())){var o=i.json.queryToJson($(this).attr("action-data"));o.comment=encodeURIComponent(n.val()),$.ajax({type:"post",url:s.AJAX.ADD_COMMENT,dataType:"json",data:o,success:function(e){200==e.code?l.litePrompt("评论成功！",{timeout:1500,hideCallback:function(){var e=$("[action-type=unreply]",t.prev()[0]);e.attr("action-type","reply"),t.remove()}}):l.alertPopup("评论失败："+e.msg)}})}}e.stopPropagation(),e.preventDefault()});var m='<div class="detail"><div class="clearfix"><div style="text-align: center;"><p>确认删除？</p></div><div class="btn"><a class="W_btn_b" href="javascript:void(0);" node-type="confirmBtn"><span>确认</span></a><a class="W_btn_a" href="javascript:void(0);" node-type="cancelBtn"><span>取消</span></a></div></div></div>';p.$commentList.delegate("[action-type=delDianping]","click",function(e){var t=i.json.queryToJson($(this).attr("action-data")),n=l.createModulePopup();n.setTitle("提示"),n.setContent(m),n.show(),n.setMiddle();var o=i.dom.parseDOM(i.dom.builder(n.getInner()).list);$(o.confirmBtn).click(function(){$.ajax({type:"get",url:s.AJAX.DELETE_DIANPING,dataType:"json",data:t,success:function(e){200==e.code?(n.destroy(),l.litePrompt("删除成功！",{timeout:1500,hideCallback:function(){setTimeout(function(){window.location.reload()},20)}})):(n.destroy(),l.alertPopup("删除失败："+e.msg))}})}),$(o.cancelBtn).click(function(){n.destroy()}),e.stopPropagation(),e.preventDefault()}),p.$commentList.delegate("[action-type=modifyDianping]","click",function(e){var t=$(this),n=i.json.queryToJson($(this).attr("action-data"));$.ajax({type:"get",dataType:"json",url:s.AJAX.GET_DIANPING,data:{id:n.id},success:function(e){var o=i.json.queryToJson(p.$showList.attr("node-data"));d.show({content:e.html.body,confirmFn:function(e,a){if(i.str.trim(e)){var r="",c=/src=[\'\"]?([^\'\"]*)[\'\"]?/i,d=e.match(/<img.*?(?:>|\/>)/gi);if(d)for(var p=0;p<d.length;p++){var f=d[p].match(c);f[1]&&(r+=f[1].replace(/!popup$/,"")+",")}$.ajax({type:"post",url:s.AJAX.ADD_DIANPING,dataType:"json",data:{body:encodeURIComponent(e),pics:r.replace(/,$/,""),shop_id:o&&o.shop_id,score:u.getResult(),id:n.id},success:function(e){"200"==e.code?(a.destroy(),l.litePrompt("晒单成功！",{timeout:1500,hideCallback:function(){t[0].parentNode&&t[0].parentNode.parentNode&&(t[0].parentNode.parentNode.outerHTML=e.html)}})):(a.destroy(),l.litePrompt(e.msg,{timeout:1500}))}})}else l.alertPopup("点评内容不能为空")}}),u.init({elemId:"rating",score:e.html.score})}}),e.stopPropagation(),e.preventDefault()}),a.initialize("page_container","comment_list",s.AJAX.GET_COMMENT);var h=0,g=parseInt(p.$shopIntro.css("height"),10);isNaN(g)&&(g=parseInt(p.$shopIntro[0].offsetHeight,10)),h=g,g>245&&(p.$shopIntro.css("height","245"),p.$seeMore.css("display","block"),p.$seeMore.on("click",e));var v,y,b,w,x='<div class="detail"><div class="clearfix"><span id="prevImg" class="leftcursor"></span><img id="popImg" style="width: 450px;" src="{{imgSrc}}" imgindex="{{imgIndex}}"><span id="nextImg" class="rightcursor"></span></div></div>',_=[];p.$showImgPop.click(function(e){w=l.createModulePopup({}),_=[];var t=i.json.queryToJson($(this).attr("node-data"));y=t.shop_id,n({}),e.preventDefault()});var T='<div id="detailmap-layer-wraper"><div id="detailmap-canvas" style="height:{{height}}px;width:{{width}}px;"></div></div>';p.$showMap.click(function(){var e=$(window).width(),t=$(window).height(),n=r.compile(T).render({width:parseInt(e-150,10),height:parseInt(t-100,10)}),o=l.createModulePopup({});o.setContent(n),o.show(),o.setMiddle();var i={lat:$("#lat").html(),lon:$("#lon").html(),shopName:$("#shop_name").html(),shopDesc:$("#shop_desc").html(),shopAddr:$("#shop_address").html()};!function(e){var t=new google.maps.LatLng(e.lon,e.lat),n={zoom:14,center:t,mapTypeId:google.maps.MapTypeId.ROADMAP},o=new google.maps.Map($("#detailmap-canvas")[0],n),i='<div style="overflow:hidden;width:300px;"><h2>'+e.shopName+"</h2><br><div>"+e.shopDesc+"</div><br><p>地址: "+e.shopAddr+"</p></div>",a=new google.maps.InfoWindow({content:i}),s=new google.maps.Marker({position:t,map:o});!function(e){google.maps.event.addListener(e,"click",function(){a.open(o,e)})}(s),setTimeout(function(){a.open(o,s)},1e3)}(i)})});